<!-- public/index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pa√±cƒÅ·πÖga</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 1em; }
    
    /* Authentication Header */
    .auth-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #667eea;
    }
    
    .user-details h3 {
      margin: 0;
      font-size: 1.1rem;
    }
    
    .user-details p {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Navigation */
    .nav-tabs {
      display: flex;
      margin-bottom: 2rem;
      border-bottom: 2px solid #eee;
    }
    
    .nav-tab {
      padding: 1rem 2rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .nav-tab.active {
      border-bottom-color: #667eea;
      color: #667eea;
      font-weight: bold;
    }
    
    .nav-tab:hover {
      background: #f8f9fa;
    }
    
    /* Content sections */
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    /* Existing styles */
    #messages { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: .5em; }
    .message { margin-bottom: .5em; }
    .panchanga { background: #f0f8ff; padding: .5em; border-radius: 4px; }
    label { display: block; margin: .5em 0; }
    input, select, button { padding: .4em; margin-right: .5em; }
    
    /* Login prompt */
    .login-prompt {
      text-align: center;
      padding: 3rem;
      background: #f8f9fa;
      border-radius: 10px;
      margin: 2rem 0;
    }
    
    .login-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 25px;
      font-size: 1.1rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <!-- Authentication Header -->
  <div class="auth-header" id="authHeader" style="display: none;">
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="user-details">
        <h3 id="userName">User</h3>
        <p id="userEmail">user@example.com</p>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- Login Prompt -->
  <div class="login-prompt" id="loginPrompt">
    <h2>üîÆ Welcome to Kunadli</h2>
    <p>Vedic Astrology & Panchanga Calculator</p>
    <p>Please login to access the application</p>
    <a href="/login.html" class="login-btn">Login with Google</a>
  </div>

  <!-- Main Content (only shown when authenticated) -->
  <div id="mainContent" style="display: none;">
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <div class="nav-tab active" onclick="showTab('panchanga')">Panchanga Calculator</div>
      <div class="nav-tab" onclick="showTab('horoscope')">Horoscope Calculator</div>
    </div>

    <!-- Panchanga Section -->
    <div class="content-section active" id="panchangaSection">
      <h2>Calculate Panchanga</h2>
      <div id="messages"></div>

      <label>Your Name:<br/><input id="user" placeholder="Enter your name" /></label>
      <label>Date & Time:<br/>
        <input id="date" type="date" />
        <input id="time" type="time" />
      </label>
      <label>Timezone:<br/><input id="tz" placeholder="e.g. America/New_York" /></label>
      <label>Place (lat,lon):<br/><input id="place" placeholder="Latitude,Longitude" /></label>

      <label>AyanƒÅmsa:<br/>
        <select id="ayanamsa">
          <option value="0">Fagan/Bradley</option>
          <option value="1" selected>Lahiri</option>
          <option value="2">DeLu</option>
          <option value="3">Raman</option>
          <option value="4">Krishnamurti</option>
          <option value="6">ED50</option>
          <option value="7">Dehant</option>
        </select>
      </label>

      <button id="sendPanchanga">Calculate Panchanga</button>
    </div>

    <!-- Horoscope Section -->
    <div class="content-section" id="horoscopeSection">
      <h2>Horoscope Calculator</h2>
      <p>Redirecting to horoscope page...</p>
      <script>
        // Redirect to horoscope page
        setTimeout(() => {
          window.location.href = '/horoscope.html';
        }, 1000);
      </script>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket     = io();
    const messages   = document.getElementById('messages');
    const userInput  = document.getElementById('user');
    const dateInput  = document.getElementById('date');
    const timeInput  = document.getElementById('time');
    const tzInput    = document.getElementById('tz');
    const placeInput = document.getElementById('place');
    const ayanInput  = document.getElementById('ayanamsa');
    const btn        = document.getElementById('sendPanchanga');

    // Authentication functions
    function checkAuth() {
      fetch('/auth/status')
        .then(response => response.json())
        .then(data => {
          if (data.authenticated) {
            showAuthenticatedUser(data.user);
          } else {
            showLoginPrompt();
          }
        })
        .catch(error => {
          console.error('Auth check failed:', error);
          showLoginPrompt();
        });
    }

    function showAuthenticatedUser(user) {
      document.getElementById('loginPrompt').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('authHeader').style.display = 'flex';
      
      document.getElementById('userName').textContent = user.displayName;
      document.getElementById('userEmail').textContent = user.email;
      
      if (user.picture) {
        document.getElementById('userAvatar').innerHTML = `<img src="${user.picture}" style="width: 100%; height: 100%; border-radius: 50%;" />`;
      } else {
        document.getElementById('userAvatar').textContent = user.displayName.charAt(0).toUpperCase();
      }
    }

    function showLoginPrompt() {
      document.getElementById('loginPrompt').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('authHeader').style.display = 'none';
    }

    function logout() {
      fetch('/auth/logout')
        .then(response => response.json())
        .then(data => {
          localStorage.removeItem('authToken');
          showLoginPrompt();
        })
        .catch(error => {
          console.error('Logout failed:', error);
          localStorage.removeItem('authToken');
          showLoginPrompt();
        });
    }

    function showTab(tabName) {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(tabName + 'Section').classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
    }

    function appendMessage(html) {
      const d = document.createElement('div');
      d.classList.add('message');
      d.innerHTML = html;
      messages.appendChild(d);
      messages.scrollTop = messages.scrollHeight;
    }

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      
      // prefill
      const now = new Date();
      dateInput.value = now.toISOString().slice(0,10);
      timeInput.value = now.toTimeString().slice(0,5);
      tzInput.value   = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          placeInput.value = `${pos.coords.latitude.toFixed(5)},${pos.coords.longitude.toFixed(5)}`;
        });
      }
    });

    btn.addEventListener('click', () => {
      socket.emit('calculatePanchanga', {
        user:     userInput.value,
        date:     dateInput.value,
        time:     timeInput.value,
        timezone: tzInput.value,
        place:    placeInput.value,
        ayanamsa: ayanInput.value
      });
    });

    socket.on('panchangaCalculated', data => {
      console.log('Payload:', data);
      const {
        user, date, time, timezone, place, ayanamsaUsed,
        sunrise, sunset, tithi, nakshatra, yoga, karana1, karana2,
        paksha, weekday, amantaMonth, purnimantaMonth, moonSign, sunSign
      } = data;

      appendMessage(`
        <div class="panchanga">
          <strong>${user}</strong>'s Pa√±cƒÅ·πÖga for ${date} ${time} (${timezone}) @ ${place}:<br/>
          ‚Ä¢ AyanƒÅmsa: ${ayanamsaUsed}<br/>
          ‚Ä¢ Sunrise: ${sunrise}<br/>
          ‚Ä¢ Sunset: ${sunset}<br/>
          ‚Ä¢ Tithi: ${tithi.name} up to ${tithi.endTime}<br/>
          ‚Ä¢ Nak·π£atra: ${nakshatra.name} up to ${nakshatra.endTime}<br/>
          ‚Ä¢ Yoga: ${yoga.name} up to ${yoga.endTime}<br/>
          ‚Ä¢ Karana 1: ${karana1.name} up to ${karana1.endTime}<br/>
          ‚Ä¢ Karana 2: ${karana2.name} up to ${karana2.endTime}<br/>
          ‚Ä¢ Pak·π£a: ${paksha}<br/>
          ‚Ä¢ VƒÅra: ${weekday}<br/>
          ‚Ä¢ Amanta Month: ${amantaMonth}<br/>
          ‚Ä¢ P≈´r·πáimanta Month: ${purnimantaMonth}<br/>
          ‚Ä¢ Moon Sign: ${moonSign}<br/>
          ‚Ä¢ Sun Sign: ${sunSign}<br/>
        </div>
      `);
    });

    socket.on('errorMessage', msg => {
      appendMessage(`<span style="color:red;">Error: ${msg}</span>`);
    });
  </script>
</body>
</html>
