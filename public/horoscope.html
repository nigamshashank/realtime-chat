<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vedic Horoscope Calculator</title>
  <link rel="icon" type="image/png" href="/image/favicon.png">
  <link rel="shortcut icon" href="/favicon.ico">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 20px;
      background: #f5f5f5;
    }
    
    /* Authentication Header */
    .auth-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #667eea;
    }
    
    .user-details h3 {
      margin: 0;
      font-size: 1.1rem;
    }
    
    .user-details p {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .header-images {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 0 1rem;
    }
    
    .header-image {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 25%;
      min-width: 80px;
      max-width: 200px;
    }
    
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Navigation */
    .nav-links {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .nav-link {
      color: #667eea;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    
    .nav-link:hover {
      background: #f0f0f0;
    }
    
    .nav-link.active {
      background: #667eea;
      color: white;
    }
    
    /* Login prompt */
    .login-prompt {
      text-align: center;
      padding: 3rem;
      background: white;
      border-radius: 10px;
      margin: 2rem 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .login-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 25px;
      font-size: 1.1rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 1rem;
    }
    
    .container {
      display: flex;
      gap: 20px;
    }
    
    .form-section {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chart-section {
      flex: 2;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1, h2 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    button {
      background: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }
    
    button:hover {
      background: #45a049;
    }
    
    .north-indian-chart-container {
      position: relative;
      width: 600px;
      height: 600px;
      margin: 20px auto;
      border: 2px solid #333;
    }
    
    .north-indian-chart {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="100" height="100" stroke="black" fill="transparent" stroke-width="1"/><line x1="0" y1="0" x2="100" y2="100" stroke="black" stroke-width="1"/><line x1="100" y1="0" x2="0" y2="100" stroke="black" stroke-width="1"/><line x1="0" y1="50" x2="50" y2="0" stroke="black" stroke-width="1"/><line x1="50" y1="0" x2="100" y2="50" stroke="black" stroke-width="1"/><line x1="100" y1="50" x2="50" y2="100" stroke="black" stroke-width="1"/><line x1="50" y1="100" x2="0" y2="50" stroke="black" stroke-width="1"/></svg>');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    
    /* North Indian Chart - True Geometric House Positions */
    .ni-house { width: 18%; height: 18%; position: absolute; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 15px; background: rgba(255,255,255,0.85); border-radius: 8px; pointer-events: none; }
    /* Center diamond (H1/Lagna) */
    .ni-house-1 { top: 8%; left: 40%; }
    /* Top triangle (H2) */
    .ni-house-2 { top: 1%; left: 15%; }
    /* Top-right kite (H3) */
    .ni-house-3 { top: 10%; left: 1%; }
    /* Right triangle (H4) */
    .ni-house-4 { top: 45%; left: 15%; }
    /* Bottom-right kite (H5) */
    .ni-house-5 { top: 66%; left: 1%; }
    /* Bottom triangle (H6) */
    .ni-house-6 { top: 85%; left: 15%; }
    /* Bottom-left kite (H7) */
    .ni-house-7 { top: 66%; left: 40%; }
    /* Left triangle (H8) */
    .ni-house-8 { top: 85%; left: 65%; }
    /* Top-left kite (H9) */
    .ni-house-9 { top: 66%; left: 85%; }
    /* Top-left corner (H10) */
    .ni-house-10 { top: 45%; left: 65%; }
    /* Top-right corner (H11) */
    .ni-house-11 { top: 10%; left: 85%; }
    /* Bottom-right corner (H12) */
    .ni-house-12 { top: 1%; left: 65%; }
    
    .ni-house .sign {
      font-weight: bold;
      color: #e53935;
      font-size: 18px;
      margin-bottom: 2px;
    }
    
    .ni-house .planets {
      font-size: 11px;
      line-height: 1.2;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 2px;
    }
    
    .ni-house .planet {
      display: inline-block;
      background: #f0f0f0;
      padding: 2px 4px;
      border-radius: 3px;
      margin: 0;
      font-weight: bold;
      border: 1px solid #ccc;
    }

    .lagna-house {
      font-weight: bold;
      /* background-color: rgba(255, 255, 0, 0.1); */
    }
    .lagna-house .sign {
      color: #000;
      text-decoration: underline;
    }

    .planet-list {
      margin-top: 20px;
    }
    
    .planet-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .retrograde {
      color: red;
      font-weight: bold;
    }
    
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
    
    .error {
      color: red;
      background: #ffe6e6;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <!-- Authentication Header -->
  <div class="auth-header" id="authHeader" style="display: none;">
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="user-details">
        <h3 id="userName">User</h3>
        <p id="userEmail">user@example.com</p>
      </div>
    </div>
    <div class="header-images">
      <img src="/image/favicon.png" alt="Favicon" class="header-image">
      <img src="/image/saraswatiji.png" alt="Saraswati Ji" class="header-image">
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- Login Prompt -->
  <div class="login-prompt" id="loginPrompt">
    <h2>ðŸ”® Welcome to Kunadli</h2>
    <p>Vedic Astrology & Panchanga Calculator</p>
    <p>Please login to access the horoscope calculator</p>
    <a href="/login.html" class="login-btn">Login with Google</a>
  </div>

  <!-- Main Content (only shown when authenticated) -->
  <div id="mainContent" style="display: none;">
    <!-- Navigation -->
    <div class="nav-links">
      <a href="/" class="nav-link">Panchanga Calculator</a>
      <a href="/horoscope.html" class="nav-link active">Horoscope Calculator</a>
    </div>

    <h1>Vedic Horoscope Calculator</h1>
    
    <div class="container">
      <div class="form-section">
        <h2>Saved Horoscopes</h2>
        <div class="form-group">
          <label for="savedHoroscopes">Select a saved horoscope:</label>
          <select id="savedHoroscopes" style="margin-bottom: 10px;">
            <option value="">-- Select a saved horoscope --</option>
          </select>
          <button type="button" id="loadSavedHoroscope" style="background: #007bff; margin-left: 10px; width: auto; padding: 8px 16px;">Load Selected Horoscope</button>
          <button type="button" id="refreshSavedHoroscopes" style="background: #28a745; margin-left: 10px; width: auto; padding: 8px 16px;">Refresh List</button>
          <button type="button" id="deleteSavedHoroscope" style="background: #dc3545; margin-left: 10px; width: auto; padding: 8px 16px;">Delete Selected Horoscope</button>
        </div>
        
        <h2>Birth Details</h2>
        <form id="horoscopeForm">
          <div class="form-group">
            <label for="name">Full Name:</label>
            <input type="text" id="name" required>
          </div>
          
          <div class="form-group">
            <label for="dateOfBirth">Date of Birth:</label>
            <input type="date" id="dateOfBirth" required>
          </div>
          
          <div class="form-group">
            <label for="timeOfBirth">Time of Birth:</label>
            <input type="time" id="timeOfBirth" required>
          </div>
          
          <div class="form-group">
            <label for="placeOfBirth">Place of Birth:</label>
            <input type="text" id="placeOfBirth" placeholder="e.g., Mumbai, India" required>
          </div>
          
          <div class="form-group">
            <label for="latitude">Latitude:</label>
            <input type="text" id="latitude" placeholder="e.g., 19.0760N or -19.0760" required>
            <small style="color: #666;">Format: 19.0760N (North) or -19.0760 (South)</small>
          </div>
          
          <div class="form-group">
            <label for="longitude">Longitude:</label>
            <input type="text" id="longitude" placeholder="e.g., 72.8777E or -72.8777" required>
            <small style="color: #666;">Format: 72.8777E (East) or -72.8777 (West)</small>
          </div>
          
          <div class="form-group">
            <label for="timezone">Timezone:</label>
            <input type="text" id="timezone" placeholder="e.g., Asia/Kolkata" required>
          </div>
          
          <div class="form-group">
            <label for="ayanamsa">Ayanamsa:</label>
            <select id="ayanamsa">
              <option value="1">Lahiri</option>
              <option value="0">Fagan/Bradley</option>
              <option value="2">DeLu</option>
              <option value="3">Raman</option>
              <option value="4">Krishnamurti</option>
              <option value="5" selected>Pushya Paksha</option>
              <option value="6">ED50</option>
              <option value="7">Dehant</option>
            </select>
          </div>
          
          <button type="submit">Calculate Horoscope</button>
        </form>
      </div>
      
      <div class="chart-section">
        <h2>Birth Chart (Kundali)</h2>
        <div id="loading" class="loading" style="display: none;">Calculating horoscope...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="chartContainer" style="display: none;">
          <div class="north-indian-chart-container">
            <div class="north-indian-chart" id="northIndianChart">
              <!-- Houses will be dynamically generated here -->
            </div>
          </div>
          
          <div class="planet-list" id="planetList"></div>
          
          <div id="lagnaInfo"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const form = document.getElementById('horoscopeForm');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const chartContainer = document.getElementById('chartContainer');
    const northIndianChart = document.getElementById('northIndianChart');
    const planetList = document.getElementById('planetList');
    const lagnaInfo = document.getElementById('lagnaInfo');

    // Authentication functions
    function checkAuth() {
      fetch('/auth/status')
        .then(response => response.json())
        .then(data => {
          if (data.authenticated) {
            showAuthenticatedUser(data.user);
          } else {
            showLoginPrompt();
          }
        })
        .catch(error => {
          console.error('Auth check failed:', error);
          showLoginPrompt();
        });
    }

    let currentUser = null;

    function showAuthenticatedUser(user) {
      currentUser = user; // Store user for later use
      document.getElementById('loginPrompt').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('authHeader').style.display = 'flex';
      
      document.getElementById('userName').textContent = user.displayName;
      document.getElementById('userEmail').textContent = user.email;
      
      if (user.picture) {
        document.getElementById('userAvatar').innerHTML = `<img src="${user.picture}" style="width: 100%; height: 100%; border-radius: 50%;" />`;
      } else {
        document.getElementById('userAvatar').textContent = user.displayName.charAt(0).toUpperCase();
      }
      
      // Add admin link if user is admin
      if (user.role === 'admin') {
        const navLinks = document.querySelector('.nav-links');
        if (!document.querySelector('.nav-link[href="/admin.html"]')) {
          const adminLink = document.createElement('a');
          adminLink.href = '/admin.html';
          adminLink.className = 'nav-link';
          adminLink.textContent = 'Admin Dashboard';
          navLinks.appendChild(adminLink);
        }
      }
    }

    function showLoginPrompt() {
      document.getElementById('loginPrompt').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('authHeader').style.display = 'none';
    }

    function logout() {
      fetch('/auth/logout')
        .then(response => response.json())
        .then(data => {
          localStorage.removeItem('authToken');
          showLoginPrompt();
        })
        .catch(error => {
          console.error('Logout failed:', error);
          localStorage.removeItem('authToken');
          showLoginPrompt();
        });
    }

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
    });

    // Pre-fill form with current date/time and timezone
    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      const dateInput = document.getElementById('dateOfBirth');
      const timeInput = document.getElementById('timeOfBirth');
      const timezoneInput = document.getElementById('timezone');
      if (dateInput) dateInput.value = now.toLocaleDateString('en-CA'); // YYYY-MM-DD
      if (timeInput) timeInput.value = now.toTimeString().slice(0, 5); // HH:MM
      if (timezoneInput) timezoneInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone;
      initializePlaceAutocomplete();
      
      // Load saved horoscopes
      loadSavedHoroscopes();
    });

    // Place of Birth Autocomplete
    function initializePlaceAutocomplete() {
      const placeOfBirthInput = document.getElementById('placeOfBirth');
      const latitudeInput = document.getElementById('latitude');
      const longitudeInput = document.getElementById('longitude');
      const timezoneInput = document.getElementById('timezone');
      if (!placeOfBirthInput) return;
      // Create autocomplete container
      let autocompleteContainer = document.getElementById('autocompleteContainer');
      if (!autocompleteContainer) {
        autocompleteContainer = document.createElement('div');
        autocompleteContainer.id = 'autocompleteContainer';
        autocompleteContainer.style.cssText = `
          position: absolute;
          background: white;
          border: 1px solid #ddd;
          border-top: none;
          max-height: 200px;
          overflow-y: auto;
          width: 100%;
          z-index: 1000;
          display: none;`;
        const placeGroup = placeOfBirthInput.parentElement;
        placeGroup.style.position = 'relative';
        placeGroup.appendChild(autocompleteContainer);
      }
      let searchTimeout;
      placeOfBirthInput.addEventListener('input', function() {
        const query = placeOfBirthInput.value.trim();
        if (query.length < 2) {
          autocompleteContainer.style.display = 'none';
          return;
        }
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchPlaces(query), 300);
      });
      placeOfBirthInput.addEventListener('focus', function() {
        const query = placeOfBirthInput.value.trim();
        if (query.length >= 2) searchPlaces(query);
      });
      placeOfBirthInput.addEventListener('blur', function() {
        setTimeout(() => { autocompleteContainer.style.display = 'none'; }, 200);
      });
      document.addEventListener('click', function(e) {
        if (!placeOfBirthInput.parentElement.contains(e.target)) {
          autocompleteContainer.style.display = 'none';
        }
      });
      async function searchPlaces(query) {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
          const places = await response.json();
          displayAutocompleteResults(places);
        } catch (error) {
          autocompleteContainer.innerHTML = `<div style='padding:10px;color:red;'>Error searching places</div>`;
          autocompleteContainer.style.display = 'block';
        }
      }
      function displayAutocompleteResults(places) {
        autocompleteContainer.innerHTML = '';
        if (!places.length) {
          autocompleteContainer.style.display = 'none';
          return;
        }
        places.forEach(place => {
          const item = document.createElement('div');
          item.style.cssText = `padding:10px;cursor:pointer;border-bottom:1px solid #eee;font-size:14px;`;
          item.innerHTML = `<div style='font-weight:bold;'>${place.display_name.split(',')[0]}</div><div style='color:#666;font-size:12px;'>${place.display_name}</div>`;
          item.addEventListener('click', () => selectPlace(place));
          item.addEventListener('mouseenter', () => { item.style.backgroundColor = '#f0f0f0'; });
          item.addEventListener('mouseleave', () => { item.style.backgroundColor = 'white'; });
          autocompleteContainer.appendChild(item);
        });
        autocompleteContainer.style.display = 'block';
      }
      async function selectPlace(place) {
        placeOfBirthInput.value = place.display_name;
        const lat = parseFloat(place.lat);
        const lon = parseFloat(place.lon);
        latitudeInput.value = lat >= 0 ? `${lat.toFixed(4)}N` : `${Math.abs(lat).toFixed(4)}S`;
        longitudeInput.value = lon >= 0 ? `${lon.toFixed(4)}E` : `${Math.abs(lon).toFixed(4)}W`;
        try {
          const tzRes = await fetch(`https://api.timezonedb.com/v2.1/get-time-zone?key=THT882HSAG63&format=json&by=position&lat=${lat}&lng=${lon}`);
          const tzData = await tzRes.json();
          if (tzData.status === 'OK') timezoneInput.value = tzData.zoneName;
        } catch (error) {}
        autocompleteContainer.style.display = 'none';
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      
      // Clear any previous errors
      error.style.display = 'none';
      
      // Debug: Log all form field values before reading
      console.log('=== FORM SUBMISSION DEBUG ===');
      console.log('Name field value:', document.getElementById('name')?.value);
      console.log('Date field value:', document.getElementById('dateOfBirth')?.value);
      console.log('Time field value:', document.getElementById('timeOfBirth')?.value);
      console.log('Place field value:', document.getElementById('placeOfBirth')?.value);
      console.log('Latitude field value:', document.getElementById('latitude')?.value);
      console.log('Longitude field value:', document.getElementById('longitude')?.value);
      console.log('Timezone field value:', document.getElementById('timezone')?.value);
      console.log('Ayanamsa field value:', document.getElementById('ayanamsa')?.value);
      
      // Always read fresh values from form fields
      const nameField = document.getElementById('name');
      const dateField = document.getElementById('dateOfBirth');
      const timeField = document.getElementById('timeOfBirth');
      const placeField = document.getElementById('placeOfBirth');
      const latField = document.getElementById('latitude');
      const lonField = document.getElementById('longitude');
      const tzField = document.getElementById('timezone');
      const ayanamsaField = document.getElementById('ayanamsa');
      
      // Get all form data with fresh values
      const formData = {
        name: nameField ? nameField.value.trim() : '',
        dateOfBirth: dateField ? dateField.value : '',
        timeOfBirth: timeField ? timeField.value : '',
        placeOfBirth: placeField ? placeField.value.trim() : '',
        latitude: latField ? latField.value.trim() : '',
        longitude: lonField ? lonField.value.trim() : '',
        timezone: tzField ? tzField.value.trim() : '',
        ayanamsa: ayanamsaField ? ayanamsaField.value : '5',
        userId: currentUser ? currentUser.id : null
      };

      // Debug: Log the form data being sent
      console.log('Form data object:', formData);
      console.log('Form data JSON:', JSON.stringify(formData, null, 2));

      // Validate required fields
      const requiredFields = ['name', 'dateOfBirth', 'timeOfBirth', 'placeOfBirth', 'latitude', 'longitude', 'timezone'];
      for (const field of requiredFields) {
        if (!formData[field]) {
          error.textContent = `Please fill in all required fields. Missing: ${field}`;
          error.style.display = 'block';
          console.error('Validation failed for field:', field, 'Value:', formData[field]);
          return;
        }
      }

      // Show loading
      loading.style.display = 'block';
      chartContainer.style.display = 'none';

      // Send to server
      console.log('Sending horoscope calculation request with data:', formData);
      socket.emit('calculateHoroscope', formData);
      
      // Debug: Check if form fields are modified after sending
      setTimeout(() => {
        console.log('=== FORM FIELDS AFTER SEND ===');
        console.log('Name field value after send:', document.getElementById('name')?.value);
        console.log('Date field value after send:', document.getElementById('dateOfBirth')?.value);
        console.log('Time field value after send:', document.getElementById('timeOfBirth')?.value);
        console.log('Place field value after send:', document.getElementById('placeOfBirth')?.value);
        console.log('Latitude field value after send:', document.getElementById('latitude')?.value);
        console.log('Longitude field value after send:', document.getElementById('longitude')?.value);
        console.log('Timezone field value after send:', document.getElementById('timezone')?.value);
        console.log('Ayanamsa field value after send:', document.getElementById('ayanamsa')?.value);
      }, 100);
    });

    socket.on('horoscopeCalculated', (data) => {
      console.log('=== HOROSCOPE CALCULATED RESPONSE ===');
      console.log('Received data:', data);
      loading.style.display = 'none';
      displayHoroscope(data);
    });

    socket.on('errorMessage', (msg) => {
      console.log('=== ERROR MESSAGE ===');
      console.log('Error received:', msg);
      loading.style.display = 'none';
      error.textContent = msg;
      error.style.display = 'block';
    });

    function displayHoroscope(data) {
      // Clear previous content first
      chartContainer.style.display = 'block';
      northIndianChart.innerHTML = '';
      planetList.innerHTML = '';
      lagnaInfo.innerHTML = '';
      
      // Reset any global variables or state
      if (window.toggleDashaChildren) {
        delete window.toggleDashaChildren;
      }
      
      console.log('Displaying horoscope with data:', data);
      
      // Display Ayanamsa and Lagna info
      lagnaInfo.innerHTML = `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
          <h3 style="margin-top: 0; color: #007bff;">Ayanamsa Information</h3>
          <p><strong>Ayanamsa Used:</strong> ${data.ayanamsaUsed || 'Not specified'}</p>
          <p><strong>Ayanamsa Value:</strong> ${data.dashaInfo ? data.dashaInfo.ayanamsa.toFixed(2) + 'Â°' : 'N/A'}</p>
          <p><strong>Moon Sidereal Longitude:</strong> ${data.dashaInfo ? data.dashaInfo.moonSiderealLongitude.toFixed(2) + 'Â°' : 'N/A'}</p>
          <p><strong>Nakshatra:</strong> ${data.dashaInfo ? data.dashaInfo.nakshatra : 'N/A'}</p>
          <p><strong>Dasha Lord:</strong> ${data.dashaInfo ? data.dashaInfo.dashaLord : 'N/A'}</p>
          <p><strong>Dasha Balance:</strong> ${data.dashaInfo ? (data.dashaInfo.dashaBalance * 100).toFixed(2) + '%' : 'N/A'}</p>
          <p style="font-size: 0.9em; color: #666; margin-top: 10px; font-style: italic;">
            <strong>Note:</strong> Ayanamsa is the difference between tropical and sidereal zodiac. 
            Different ayanamsa systems (Lahiri, Pushya Paksha, etc.) can result in different nakshatra and dasha calculations.
          </p>
        </div>
        
        <h3>Lagna (Ascendant)</h3>
        <p><strong>${data.lagna.sign}</strong> ${data.lagna.degree.toFixed(2)}Â°</p>
        <p>Longitude: ${data.lagna.longitude.toFixed(2)}Â°</p>
      `;

      // North Indian house order: top center (Lagna), then anticlockwise
      // [H1 (top center), H2 (top left), H3 (left), H4 (bottom left), H5 (bottom center), H6 (bottom right), H7 (right), H8 (top right), H9 (topmost right), H10 (rightmost), H11 (bottommost right), H12 (bottommost left)]
      // For your chart, the main 12 boxes are: top center, top left, left, bottom left, bottom center, bottom right, right, top right, and the 4 corners.
      // We'll use the order: [1,2,3,4,5,6,7,8,9,10,11,12] where 1 is top center (Lagna), then anticlockwise.
      const houseOrder = [1,2,3,4,5,6,7,8,9,10,11,12];
      const chart = document.getElementById('northIndianChart');
      chart.innerHTML = '';

      // Get Lagna rashi number
      const lagnaRashi = data.lagna.signNumber;

      houseOrder.forEach((houseNum, idx) => {
        // Compute rashi number for this house (anticlockwise from Lagna)
        const rashiNumber = ((lagnaRashi + idx - 1) % 12) + 1;
        // Find all planets in this rashi, excluding Neptune, Uranus, Pluto
        const planetNames = Object.entries(data.planets)
          .filter(([pname, p]) => p.signNumber === rashiNumber && !['Neptune', 'Uranus', 'Pluto'].includes(pname))
          .map(([pname, p]) => {
            const retro = p.isRetrograde ? '(R)' : '';
            return `<span class=\"planet\">${pname.substring(0, 2)}${retro}</span>`;
          }).join(' ');
        const houseDiv = document.createElement('div');
        houseDiv.className = `ni-house ni-house-${houseNum}`;
        if (houseNum === 1) houseDiv.classList.add('lagna-house');
        houseDiv.innerHTML = `
          <div class=\"sign\">${rashiNumber}</div>
          <div class=\"planets\">${planetNames}</div>
        `;
        chart.appendChild(houseDiv);
      });

      // Display planet list, excluding Neptune, Uranus, Pluto
      planetList.innerHTML = '<h3>Lagna & Planetary Details</h3>';
      // Helper: Nakshatra names
      const nakshatraNames = [
        'Ashwini', 'Bharani', 'Krittika', 'Rohini', 'Mrigashira', 'Ardra',
        'Punarvasu', 'Pushya', 'Ashlesha', 'Magha', 'Purva Phalguni', 'Uttara Phalguni',
        'Hasta', 'Chitra', 'Swati', 'Vishakha', 'Anuradha', 'Jyeshtha',
        'Mula', 'Purva Ashadha', 'Uttara Ashadha', 'Shravana', 'Dhanishta', 'Shatabhisha',
        'Purva Bhadrapada', 'Uttara Bhadrapada', 'Revati'
      ];
      function getNakshatra(longitude) {
        const idx = Math.floor((longitude % 360) / (360 / 27));
        return nakshatraNames[idx];
      }
      function getPada(longitude) {
        const nakLen = 360 / 27;
        const posInNak = longitude % nakLen;
        return Math.floor((posInNak / nakLen) * 4) + 1;
      }
      // Build table rows
      let tableRows = '';
      // Lagna
      tableRows += `<tr><td>Lagna</td><td>${data.lagna.sign}</td><td>${data.lagna.degree.toFixed(2)}</td><td>${getNakshatra(data.lagna.longitude)}</td><td>${getPada(data.lagna.longitude)}</td></tr>`;
      // Planets
      for (const [planet, info] of Object.entries(data.planets)) {
        if (["Neptune", "Uranus", "Pluto"].includes(planet)) continue;
        const retrograde = info.isRetrograde ? ' (R)' : '';
        tableRows += `<tr><td>${planet}${retrograde}</td><td>${info.sign}</td><td>${info.degree.toFixed(2)}</td><td>${getNakshatra(info.longitude)}</td><td>${getPada(info.longitude)}</td></tr>`;
      }
      // Create table
      planetList.innerHTML = `
        <h3>Lagna & Planetary Details</h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
          <thead>
            <tr style="background:#f0f0f0;">
              <th>Body</th><th>Rashi</th><th>Degrees</th><th>Nakshatra</th><th>Pada</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      `;

      // Display Vimshottari Dasha Tree
      console.log('Dasha data received:', data.dashaTree);
      console.log('Dasha data type:', typeof data.dashaTree);
      console.log('Dasha data length:', data.dashaTree ? data.dashaTree.length : 'undefined');
      

      
      if (data.dashaTree && data.dashaTree.length > 0) {
        console.log('Building dasha tree with', data.dashaTree.length, 'mahadashas');
        const dashaContainer = document.createElement('div');
        dashaContainer.innerHTML = `
          <h3>Vimshottari Dasha</h3>
          <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
            <h4 style="margin-top: 0; color: #856404;">Dasha Calculation Details</h4>
            <p><strong>Birth Date:</strong> ${data.dateOfBirth} ${data.timeOfBirth}</p>
            <p><strong>Place:</strong> ${data.placeOfBirth}</p>
            <p><strong>Ayanamsa System:</strong> ${data.ayanamsaUsed || 'Not specified'}</p>
            <p><strong>Ayanamsa Mode:</strong> ${data.ayanamsaMode || 'N/A'} (${data.ayanamsaUsed || 'Not specified'})</p>
            <p><strong>Ayanamsa Value:</strong> ${data.dashaInfo ? data.dashaInfo.ayanamsa.toFixed(2) + 'Â°' : 'N/A'}</p>
            <p><strong>Moon Sidereal Longitude:</strong> ${data.dashaInfo ? data.dashaInfo.moonSiderealLongitude.toFixed(2) + 'Â°' : 'N/A'}</p>
            <p><strong>Nakshatra:</strong> ${data.dashaInfo ? data.dashaInfo.nakshatra : 'N/A'}</p>
            <p><strong>Dasha Lord:</strong> ${data.dashaInfo ? data.dashaInfo.dashaLord : 'N/A'}</p>
            <p><strong>Dasha Balance:</strong> ${data.dashaInfo ? (data.dashaInfo.dashaBalance * 100).toFixed(2) + '% remaining' : 'N/A'}</p>
            <p><strong>Dasha Start Date:</strong> ${data.dashaInfo ? new Date(data.dashaInfo.dashaStart).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) : 'N/A'}</p>
          </div>
          <div id="dashaTree" style="margin-top: 10px;"></div>
        `;
        planetList.appendChild(dashaContainer);
        
        // Build expandable dasha tree
        function buildDashaTree(dashaNodes, level = 0, path = '') {
          let html = '';
          dashaNodes.forEach((node, index) => {
            const currentPath = path ? `${path}-${index}` : `${index}`;
            const indent = '&nbsp;'.repeat(level * 4);
            const hasChildren = node.children && node.children.length > 0;
            const expandIcon = hasChildren ? 'â–¶' : '';
            
            // Convert dates to readable format
            const startDate = new Date(node.start).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'});
            const endDate = new Date(node.end).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'});
            
            // Format duration
            const duration = node.duration ? ` (${node.duration.toFixed(2)} years)` : '';
            
            // Get type label
            const typeLabel = node.type ? ` - ${node.type}` : '';
            
            html += `
              <div style="margin: 5px 0; padding: 5px; border-left: 2px solid #ddd;">
                <div style="cursor: pointer; font-weight: ${level === 0 ? 'bold' : 'normal'};" 
                     onclick="toggleDashaChildren('${currentPath}')">
                  ${indent}${expandIcon} ${node.lord}${typeLabel} (${startDate} to ${endDate})${duration}
                </div>
                <div id="dasha-children-${currentPath}" style="display: none; margin-left: 20px;">
                  ${hasChildren ? buildDashaTree(node.children, level + 1, currentPath) : ''}
                </div>
              </div>
            `;
          });
          return html;
        }
        
        document.getElementById('dashaTree').innerHTML = buildDashaTree(data.dashaTree);
        
        // Add toggle function to window
        window.toggleDashaChildren = function(path) {
          const childrenDiv = document.getElementById(`dasha-children-${path}`);
          if (childrenDiv) {
            childrenDiv.style.display = childrenDiv.style.display === 'none' ? 'block' : 'none';
          }
        };
      } else {
        console.log('No dasha data available');
        // Add debug info if dasha tree is not available
        const dashaContainer = document.createElement('div');
        dashaContainer.innerHTML = `
          <h3>Vimshottari Dasha</h3>
          <p style="color: #666; font-style: italic;">Dasha data not available</p>
        `;
        planetList.appendChild(dashaContainer);
      }
    }

    // Load saved horoscopes from server
    function loadSavedHoroscopes() {
      socket.emit('getSavedHoroscopes', {
        userId: currentUser ? currentUser.id : null,
        userRole: currentUser ? currentUser.role : null
      });
    }

    // Handle saved horoscopes response
    socket.on('savedHoroscopes', (horoscopes) => {
      const dropdown = document.getElementById('savedHoroscopes');
      dropdown.innerHTML = '<option value="">-- Select a saved horoscope --</option>';
      
      horoscopes.forEach(horoscope => {
        const option = document.createElement('option');
        option.value = horoscope._id;
        
        // Show owner for admin users
        const ownerInfo = currentUser && currentUser.role === 'admin' && horoscope.user ? 
          ` (by ${horoscope.user.displayName})` : '';
        
        option.textContent = `${horoscope.name} - ${horoscope.dateOfBirth} ${horoscope.timeOfBirth} (${horoscope.placeOfBirth})${ownerInfo}`;
        dropdown.appendChild(option);
      });
    });

    // Handle load saved horoscope button
    document.getElementById('loadSavedHoroscope').addEventListener('click', () => {
      const selectedId = document.getElementById('savedHoroscopes').value;
      if (selectedId) {
        socket.emit('getHoroscope', selectedId);
      } else {
        alert('Please select a horoscope first.');
      }
    });

    // Handle refresh saved horoscopes button
    document.getElementById('refreshSavedHoroscopes').addEventListener('click', () => {
      loadSavedHoroscopes();
    });

    // Handle delete saved horoscope button
    document.getElementById('deleteSavedHoroscope').addEventListener('click', () => {
      const selectedId = document.getElementById('savedHoroscopes').value;
      if (!selectedId) {
        alert('Please select a horoscope to delete.');
        return;
      }
      
      const selectedOption = document.getElementById('savedHoroscopes').selectedOptions[0];
      const horoscopeName = selectedOption.textContent;
      
      if (confirm(`Are you sure you want to delete this horoscope?\n\n${horoscopeName}\n\nThis action cannot be undone.`)) {
        socket.emit('deleteHoroscope', { 
          horoscopeId: selectedId, 
          userId: currentUser ? currentUser.id : null,
          userRole: currentUser ? currentUser.role : null
        });
      }
    });

    // Handle retrieved horoscope
    socket.on('horoscopeRetrieved', (horoscope) => {
      // Populate form fields
      document.getElementById('name').value = horoscope.name || '';
      document.getElementById('dateOfBirth').value = horoscope.dateOfBirth || '';
      document.getElementById('timeOfBirth').value = horoscope.timeOfBirth || '';
      document.getElementById('placeOfBirth').value = horoscope.placeOfBirth || '';
      document.getElementById('latitude').value = horoscope.latitude || '';
      document.getElementById('longitude').value = horoscope.longitude || '';
      document.getElementById('timezone').value = horoscope.timezone || '';
      document.getElementById('ayanamsa').value = horoscope.ayanamsaMode || '5';
      
      // Display the horoscope
      displayHoroscope(horoscope);
      
      // Show success message
      console.log('Loaded saved horoscope:', horoscope.name);
    });

    // Handle horoscope deletion confirmation
    socket.on('horoscopeDeleted', (message) => {
      alert(`Horoscope deleted successfully!\n\n${message}`);
      // Refresh the list to show updated data
      loadSavedHoroscopes();
      // Clear the form if the deleted horoscope was loaded
      clearForm();
    });

    // Handle deletion error
    socket.on('deleteError', (error) => {
      alert(`Error deleting horoscope: ${error}`);
    });

    // Function to clear form fields
    function clearForm() {
      document.getElementById('name').value = '';
      document.getElementById('dateOfBirth').value = '';
      document.getElementById('timeOfBirth').value = '';
      document.getElementById('placeOfBirth').value = '';
      document.getElementById('latitude').value = '';
      document.getElementById('longitude').value = '';
      document.getElementById('timezone').value = '';
      document.getElementById('ayanamsa').value = '5';
      
      // Clear the chart display
      chartContainer.style.display = 'none';
    }
  </script>
</body>
</html> 